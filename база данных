#include <iostream>
#include <fstream>
#include <cstring>
#include <cstdlib>
#include <clocale>

using namespace std;

// ==================== СТРУКТУРА ====================
struct Product
{
    wchar_t name[80]; // поддержка кириллицы
    long article;
    int quantity;
    double price;
    int discount; // 0–100
};

// ==================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
Product* db = nullptr;
int sizeDB = 0;
bool dbLoaded = false;

const char* FILE_NAME = "database.bin";

// ==================== ФУНКЦИИ ====================

void createDB()
{
    delete[] db;
    db = nullptr;
    sizeDB = 0;
    dbLoaded = true;
    wcout << L"Новая база данных создана.\n";
}

void saveDB()
{
    ofstream file(FILE_NAME, ios::binary);
    if (!file)
    {
        wcout << L"Ошибка открытия файла для записи!\n";
        return;
    }

    file.write((char*)&sizeDB, sizeof(int));
    file.write((char*)db, sizeof(Product) * sizeDB);

    file.close();
    wcout << L"База данных сохранена.\n";
}

void loadDB()
{
    ifstream file(FILE_NAME, ios::binary);
    if (!file)
    {
        wcout << L"Ошибка открытия файла!\n";
        return;
    }

    delete[] db;

    file.read((char*)&sizeDB, sizeof(int));
    db = new Product[sizeDB];
    file.read((char*)db, sizeof(Product) * sizeDB);

    file.close();
    dbLoaded = true;
    wcout << L"База данных загружена.\n";
}

void addProduct(Product*& db, int& sizeDB)
{
    Product p;

    // Очищаем буфер перед вводом строки
    wcin.ignore(32767, '\n');

    wcout << L"Наименование: ";
    wcin.getline(p.name, 80);
    if (wcslen(p.name) == 0)
    {
        wcout << L"Ошибка: пустое наименование!\n";
        return;
    }

    wcout << L"Артикул: ";
    while (!(wcin >> p.article))
    {
        wcout << L"Ошибка: нужно ввести число! Попробуйте ещё раз: ";
        wcin.clear();
        wcin.ignore(32767, '\n');
    }

    wcout << L"Количество: ";
    while (!(wcin >> p.quantity) || p.quantity < 0)
    {
        wcout << L"Ошибка: количество не может быть отрицательным! Попробуйте ещё раз: ";
        wcin.clear();
        wcin.ignore(32767, '\n');
    }

    wcout << L"Цена: ";
    while (!(wcin >> p.price) || p.price <= 0)
    {
        wcout << L"Ошибка: цена должна быть больше 0! Попробуйте ещё раз: ";
        wcin.clear();
        wcin.ignore(32767, '\n');
    }

    wcout << L"Скидка (0-100): ";
    while (!(wcin >> p.discount) || p.discount < 0 || p.discount > 100)
    {
        wcout << L"Ошибка: скидка должна быть от 0 до 100! Попробуйте ещё раз: ";
        wcin.clear();
        wcin.ignore(32767, '\n');
    }

    // Добавляем товар в массив
    Product* temp = new Product[sizeDB + 1];
    for (int i = 0; i < sizeDB; i++)
        temp[i] = db[i];
    temp[sizeDB] = p;

    delete[] db;
    db = temp;
    sizeDB++;

    wcout << L"Товар успешно добавлен!\n";
}

void printAll()
{
    if (sizeDB == 0)
    {
        wcout << L"База данных пуста.\n";
        return;
    }

    wcout << L"Артикул  Наименование        Цена     Кол-во  Скидка\n";
    for (int i = 0; i < sizeDB; i++)
    {
        wcout.width(7); wcout << db[i].article << L"  ";
        wcout.width(15); wcout << db[i].name << L"  ";
        wcout.width(7); wcout << db[i].price << L"  ";
        wcout.width(6); wcout << db[i].quantity << L"  ";
        wcout.width(3); wcout << db[i].discount << L"%\n";
    }
}

int findByArticle(long article)
{
    for (int i = 0; i < sizeDB; i++)
        if (db[i].article == article)
            return i;
    return -1;
}

void searchProduct()
{
    long art;
    wcout << L"Введите артикул: ";
    wcin >> art;

    int index = findByArticle(art);
    if (index == -1)
    {
        wcout << L"Товар не найден.\n";
        return;
    }

    wcout << L"Найден: " << db[index].name << L"\n";
    wcout << L"1 - Изменить\n2 - Удалить\n";
    int choice;
    wcin >> choice;

    if (choice == 1)
    {
        wcout << L"Новая цена: ";
        wcin >> db[index].price;
        wcout << L"Новое количество: ";
        wcin >> db[index].quantity;
        wcout << L"Новая скидка: ";
        wcin >> db[index].discount;
        wcout << L"Изменено.\n";
    }
    else if (choice == 2)
    {
        for (int i = index; i < sizeDB - 1; i++)
            db[i] = db[i + 1];

        sizeDB--;
        wcout << L"Удалено.\n";
    }
}

void printWithDiscount()
{
    bool found = false;
    for (int i = 0; i < sizeDB; i++)
        if (db[i].discount > 0)
        {
            wcout << db[i].name << L" (" << db[i].discount << L"%)\n";
            found = true;
        }
    if (!found) wcout << L"Нет товаров со скидкой.\n";
}

void printNoStock()
{
    bool found = false;
    for (int i = 0; i < sizeDB; i++)
        if (db[i].quantity == 0)
        {
            wcout << db[i].name << L"\n";
            found = true;
        }
    if (!found) wcout << L"Все товары есть в наличии.\n";
}

// ===== СОРТИРОВКА =====
int cmpName(const void* a, const void* b)
{
    return wcscmp(((Product*)a)->name, ((Product*)b)->name);
}

int cmpArticle(const void* a, const void* b)
{
    long diff = ((Product*)a)->article - ((Product*)b)->article;
    return (diff > 0) - (diff < 0);
}

int cmpQuantity(const void* a, const void* b)
{
    return ((Product*)a)->quantity - ((Product*)b)->quantity;
}

int cmpPrice(const void* a, const void* b)
{
    double diff = ((Product*)a)->price - ((Product*)b)->price;
    return (diff > 0) - (diff < 0);
}

void sortMenu()
{
    wcout << L"1-Наименование 2-Артикул 3-Количество 4-Цена\n";
    int c;
    wcin >> c;

    if (c == 1) qsort(db, sizeDB, sizeof(Product), cmpName);
    else if (c == 2) qsort(db, sizeDB, sizeof(Product), cmpArticle);
    else if (c == 3) qsort(db, sizeDB, sizeof(Product), cmpQuantity);
    else if (c == 4) qsort(db, sizeDB, sizeof(Product), cmpPrice);
    else
    {
        wcout << L"Неверный выбор!\n";
        return;
    }

    wcout << L"Отсортировано.\n";
}

// ==================== MAIN ====================
int main()
{
    setlocale(LC_ALL, ""); // подключаем поддержку русских букв
    int choice;

    do
    {
        wcout << L"\n1-Создать БД\n2-Загрузить БД\n3-Сохранить БД\n"
                 L"4-Добавить товар\n5-Показать все\n6-Поиск\n"
                 L"7-Товары со скидкой\n8-Нет в наличии\n9-Сортировка\n0-Выход\n";
        wcin >> choice;

        if ((choice > 2) && !dbLoaded)
        {
            wcout << L"Сначала создайте или загрузите БД!\n";
            continue;
        }

        switch (choice)
        {
        case 1: createDB(); break;
        case 2: loadDB(); break;
        case 3: saveDB(); break;
        case 4: addProduct(db, sizeDB); break;
        case 5: printAll(); break;
        case 6: searchProduct(); break;
        case 7: printWithDiscount(); break;
        case 8: printNoStock(); break;
        case 9: sortMenu(); break;
        case 0: wcout << L"Выход.\n"; break;
        default: wcout << L"Неверный выбор!\n"; break;
        }

    } while (choice != 0);

    delete[] db;
    return 0;
}
