#include <iostream>
#include <fstream>
#include <cstring>
#include <cstdlib>
#include <iomanip>
#include <limits>

using namespace std;

// Структура товара
struct Product {
    char name[80];
    long article;
    int quantity;
    double price;
    char discount; // 0-100 в процентах
};

// Глобальные переменные
Product* database = nullptr; // Динамический массив
int dbSize = 0;              // Количество товаров в базе
bool isDatabaseLoaded = false;
const char* FILENAME = "database.dat";

// Прототипы функций
void displayMenu();
void createNewDB();
void loadDB();
void saveDB();
void addProduct();
void displayAllProducts();
void searchByArticle();
void editProduct(Product& product);
void deleteProduct(int index);
void displayDiscountedProducts();
void displayOutOfStock();
void sortProducts();
int compareByName(const void* a, const void* b);
int compareByArticle(const void* a, const void* b);
int compareByQuantity(const void* a, const void* b);
int compareByPrice(const void* a, const void* b);
void clearInputBuffer();
bool isValidProduct(const Product& p);

int main() {
    setlocale(LC_ALL, "Russian");
    
    int choice;
    
    do {
        displayMenu();
        cout << "Выберите пункт меню: ";
        cin >> choice;
        
        switch(choice) {
            case 1:
                createNewDB();
                break;
            case 2:
                loadDB();
                break;
            case 3:
                if(isDatabaseLoaded) saveDB();
                else cout << "Сначала создайте или загрузите БД!\n";
                break;
            case 4:
                if(isDatabaseLoaded) addProduct();
                else cout << "Сначала создайте или загрузите БД!\n";
                break;
            case 5:
                if(isDatabaseLoaded) displayAllProducts();
                else cout << "Сначала создайте или загрузите БД!\n";
                break;
            case 6:
                if(isDatabaseLoaded) searchByArticle();
                else cout << "Сначала создайте или загрузите БД!\n";
                break;
            case 7:
                if(isDatabaseLoaded) displayDiscountedProducts();
                else cout << "Сначала создайте или загрузите БД!\n";
                break;
            case 8:
                if(isDatabaseLoaded) displayOutOfStock();
                else cout << "Сначала создайте или загрузите БД!\n";
                break;
            case 9:
                if(isDatabaseLoaded) sortProducts();
                else cout << "Сначала создайте или загрузите БД!\n";
                break;
            case 0:
                cout << "Выход из программы.\n";
                break;
            default:
                cout << "Неверный выбор!\n";
        }
        
        cout << "\nНажмите Enter для продолжения...";
        clearInputBuffer();
        cin.get();
        
    } while(choice != 0);
    
    // Освобождаем память при выходе
    if(database != nullptr) {
        delete[] database;
    }
    
    return 0;
}

// Отображение меню
void displayMenu() {
    system("cls");
    cout << "========== МЕНЮ УПРАВЛЕНИЯ БАЗОЙ ДАННЫХ ==========\n";
    cout << "1. Создать новую БД\n";
    cout << "2. Загрузить данные из БД\n";
    cout << "3. Сохранить БД\n";
    cout << "4. Добавить товар\n";
    cout << "5. Вывести все товары\n";
    cout << "6. Поиск товара по артикулу\n";
    cout << "7. Вывести товары со скидкой\n";
    cout << "8. Вывести отсутствующие товары\n";
    cout << "9. Сортировать товары\n";
    cout << "0. Выход\n";
    cout << "================================================\n";
}

// Создание новой БД
void createNewDB() {
    if(database != nullptr) {
        delete[] database;
        database = nullptr;
    }
    
    dbSize = 0;
    isDatabaseLoaded = true;
    
    cout << "Новая база данных создана.\n";
}

// Загрузка БД из файла
void loadDB() {
    ifstream file(FILENAME, ios::binary);
    
    if(!file) {
        cout << "Файл БД не найден. Создайте новую БД.\n";
        return;
    }
    
    // Определяем размер файла
    file.seekg(0, ios::end);
    long fileSize = file.tellg();
    file.seekg(0, ios::beg);
    
    // Проверяем, что файл не пустой и размер кратен размеру структуры
    if(fileSize <= 0 || fileSize % sizeof(Product) != 0) {
        cout << "Ошибка: файл БД поврежден!\n";
        file.close();
        return;
    }
    
    // Вычисляем количество записей
    dbSize = fileSize / sizeof(Product);
    
    // Освобождаем старую память если есть
    if(database != nullptr) {
        delete[] database;
    }
    
    // Выделяем память
    database = new Product[dbSize];
    
    // Читаем данные
    file.read((char*)database, fileSize);
    
    if(!file) {
        cout << "Ошибка чтения файла!\n";
        delete[] database;
        database = nullptr;
        dbSize = 0;
        isDatabaseLoaded = false;
        file.close();
        return;
    }
    
    file.close();
    isDatabaseLoaded = true;
    
    cout << "БД загружена. Загружено " << dbSize << " товаров.\n";
}

// Сохранение БД в файл
void saveDB() {
    if(!isDatabaseLoaded || database == nullptr) {
        cout << "Нет данных для сохранения!\n";
        return;
    }
    
    ofstream file(FILENAME, ios::binary);
    
    if(!file) {
        cout << "Ошибка открытия файла для записи!\n";
        return;
    }
    
    file.write((char*)database, dbSize * sizeof(Product));
    
    if(!file) {
        cout << "Ошибка записи в файл!\n";
        file.close();
        return;
    }
    
    file.close();
    cout << "БД сохранена. Сохранено " << dbSize << " товаров.\n";
}

// Добавление нового товара
void addProduct() {
    Product newProduct;
    
    clearInputBuffer(); // Очищаем буфер ввода
    
    // Ввод наименования
    do {
        cout << "Введите наименование товара (макс 79 символов): ";
        cin.getline(newProduct.name, 80);
        
        if(strlen(newProduct.name) == 0) {
            cout << "Наименование не может быть пустым!\n";
        }
    } while(strlen(newProduct.name) == 0);
    
    // Ввод артикула
    cout << "Введите артикул: ";
    while(!(cin >> newProduct.article) || newProduct.article <= 0) {
        cout << "Неверный артикул! Введите положительное число: ";
        cin.clear();
        clearInputBuffer();
    }
    
    // Ввод количества
    cout << "Введите количество: ";
    while(!(cin >> newProduct.quantity) || newProduct.quantity < 0) {
        cout << "Неверное количество! Введите неотрицательное число: ";
        cin.clear();
        clearInputBuffer();
    }
    
    // Ввод цены
    cout << "Введите цену: ";
    while(!(cin >> newProduct.price) || newProduct.price <= 0) {
        cout << "Неверная цена! Введите положительное число: ";
        cin.clear();
        clearInputBuffer();
    }
    
    // Ввод скидки
    int tempDiscount;
    cout << "Введите скидку (0-100%): ";
    while(!(cin >> tempDiscount) || tempDiscount < 0 || tempDiscount > 100) {
        cout << "Неверная скидка! Введите число от 0 до 100: ";
        cin.clear();
        clearInputBuffer();
    }
    newProduct.discount = static_cast<char>(tempDiscount);
    
    // Проверяем корректность данных
    if(!isValidProduct(newProduct)) {
        cout << "Ошибка: введены некорректные данные!\n";
        return;
    }
    
    // Создаем новый массив на 1 элемент больше
    Product* newDatabase = new Product[dbSize + 1];
    
    // Копируем старые данные
    for(int i = 0; i < dbSize; i++) {
        newDatabase[i] = database[i];
    }
    
    // Добавляем новый товар
    newDatabase[dbSize] = newProduct;
    
    // Удаляем старый массив и заменяем на новый
    if(database != nullptr) {
        delete[] database;
    }
    
    database = newDatabase;
    dbSize++;
    
    cout << "Товар успешно добавлен!\n";
}

// Отображение всех товаров
void displayAllProducts() {
    if(dbSize == 0) {
        cout << "База данных пуста.\n";
        return;
    }
    
    cout << "\n================================================================================\n";
    cout << left << setw(15) << "Артикул" 
         << setw(30) << "Наименование" 
         << setw(15) << "Цена" 
         << setw(15) << "Количество" 
         << setw(10) << "Скидка(%)" << endl;
    cout << "================================================================================\n";
    
    for(int i = 0; i < dbSize; i++) {
        cout << left << setw(15) << database[i].article
             << setw(30) << database[i].name
             << setw(15) << fixed << setprecision(2) << database[i].price
             << setw(15) << database[i].quantity
             << setw(10) << (int)database[i].discount << endl;
    }
    cout << "================================================================================\n";
}

// Поиск по артикулу
void searchByArticle() {
    if(dbSize == 0) {
        cout << "База данных пуста.\n";
        return;
    }
    
    long searchArticle;
    cout << "Введите артикул для поиска: ";
    cin >> searchArticle;
    
    bool found = false;
    for(int i = 0; i < dbSize; i++) {
        if(database[i].article == searchArticle) {
            cout << "\nТовар найден:\n";
            cout << "Артикул: " << database[i].article << endl;
            cout << "Наименование: " << database[i].name << endl;
            cout << "Цена: " << database[i].price << endl;
            cout << "Количество: " << database[i].quantity << endl;
            cout << "Скидка: " << (int)database[i].discount << "%" << endl;
            
            found = true;
            
            // Подменю для найденного товара
            int choice;
            cout << "\n1. Изменить данные\n";
            cout << "2. Удалить товар\n";
            cout << "0. Назад\n";
            cout << "Выберите действие: ";
            cin >> choice;
            
            switch(choice) {
                case 1:
                    editProduct(database[i]);
                    break;
                case 2:
                    deleteProduct(i);
                    break;
                case 0:
                    break;
                default:
                    cout << "Неверный выбор!\n";
            }
            
            break;
        }
    }
    
    if(!found) {
        cout << "Товар с артикулом " << searchArticle << " не найден.\n";
    }
}

// Редактирование товара
void editProduct(Product& product) {
    clearInputBuffer();
    
    int choice;
    do {
        cout << "\nРедактирование товара:\n";
        cout << "1. Изменить наименование\n";
        cout << "2. Изменить артикул\n";
        cout << "3. Изменить количество\n";
        cout << "4. Изменить цену\n";
        cout << "5. Изменить скидку\n";
        cout << "0. Завершить редактирование\n";
        cout << "Выберите поле для редактирования: ";
        cin >> choice;
        
        clearInputBuffer();
        
        switch(choice) {
            case 1: {
                cout << "Текущее наименование: " << product.name << endl;
                cout << "Введите новое наименование: ";
                cin.getline(product.name, 80);
                if(strlen(product.name) == 0) {
                    cout << "Наименование не может быть пустым!\n";
                    cout << "Введите наименование: ";
                    cin.getline(product.name, 80);
                }
                break;
            }
            case 2: {
                cout << "Текущий артикул: " << product.article << endl;
                cout << "Введите новый артикул: ";
                while(!(cin >> product.article) || product.article <= 0) {
                    cout << "Неверный артикул! Введите положительное число: ";
                    cin.clear();
                    clearInputBuffer();
                }
                break;
            }
            case 3: {
                cout << "Текущее количество: " << product.quantity << endl;
                cout << "Введите новое количество: ";
                while(!(cin >> product.quantity) || product.quantity < 0) {
                    cout << "Неверное количество! Введите неотрицательное число: ";
                    cin.clear();
                    clearInputBuffer();
                }
                break;
            }
            case 4: {
                cout << "Текущая цена: " << product.price << endl;
                cout << "Введите новую цену: ";
                while(!(cin >> product.price) || product.price <= 0) {
                    cout << "Неверная цена! Введите положительное число: ";
                    cin.clear();
                    clearInputBuffer();
                }
                break;
            }
            case 5: {
                cout << "Текущая скидка: " << (int)product.discount << "%" << endl;
                int tempDiscount;
                cout << "Введите новую скидку (0-100%): ";
                while(!(cin >> tempDiscount) || tempDiscount < 0 || tempDiscount > 100) {
                    cout << "Неверная скидка! Введите число от 0 до 100: ";
                    cin.clear();
                    clearInputBuffer();
                }
                product.discount = static_cast<char>(tempDiscount);
                break;
            }
            case 0:
                cout << "Редактирование завершено.\n";
                break;
            default:
                cout << "Неверный выбор!\n";
        }
        
        if(choice != 0 && !isValidProduct(product)) {
            cout << "Ошибка: введены некорректные данные!\n";
        }
        
    } while(choice != 0);
}

// Удаление товара
void deleteProduct(int index) {
    if(index < 0 || index >= dbSize) {
        cout << "Неверный индекс товара!\n";
        return;
    }
    
    if(dbSize == 1) {
        delete[] database;
        database = nullptr;
        dbSize = 0;
        cout << "Товар удален. База данных теперь пуста.\n";
        return;
    }
    
    // Создаем новый массив на 1 элемент меньше
    Product* newDatabase = new Product[dbSize - 1];
    
    // Копируем все кроме удаляемого элемента
    for(int i = 0, j = 0; i < dbSize; i++) {
        if(i != index) {
            newDatabase[j++] = database[i];
        }
    }
    
    // Удаляем старый массив и заменяем на новый
    delete[] database;
    database = newDatabase;
    dbSize--;
    
    cout << "Товар успешно удален.\n";
}

// Отображение товаров со скидкой
void displayDiscountedProducts() {
    if(dbSize == 0) {
        cout << "База данных пуста.\n";
        return;
    }
    
    bool found = false;
    cout << "\nТовары со скидкой:\n";
    cout << "================================================================================\n";
    cout << left << setw(15) << "Артикул" 
         << setw(30) << "Наименование" 
         << setw(15) << "Цена" 
         << setw(15) << "Количество" 
         << setw(10) << "Скидка(%)" << endl;
    cout << "================================================================================\n";
    
    for(int i = 0; i < dbSize; i++) {
        if(database[i].discount > 0) {
            found = true;
            cout << left << setw(15) << database[i].article
                 << setw(30) << database[i].name
                 << setw(15) << fixed << setprecision(2) << database[i].price
                 << setw(15) << database[i].quantity
                 << setw(10) << (int)database[i].discount << endl;
        }
    }
    
    if(!found) {
        cout << "Товары со скидкой отсутствуют.\n";
    }
    cout << "================================================================================\n";
}

// Отображение отсутствующих товаров
void displayOutOfStock() {
    if(dbSize == 0) {
        cout << "База данных пуста.\n";
        return;
    }
    
    bool found = false;
    cout << "\nОтсутствующие товары (количество = 0):\n";
    cout << "================================================================================\n";
    cout << left << setw(15) << "Артикул" 
         << setw(30) << "Наименование" 
         << setw(15) << "Цена" 
         << setw(15) << "Количество" 
         << setw(10) << "Скидка(%)" << endl;
    cout << "================================================================================\n";
    
    for(int i = 0; i < dbSize; i++) {
        if(database[i].quantity == 0) {
            found = true;
            cout << left << setw(15) << database[i].article
                 << setw(30) << database[i].name
                 << setw(15) << fixed << setprecision(2) << database[i].price
                 << setw(15) << database[i].quantity
                 << setw(10) << (int)database[i].discount << endl;
        }
    }
    
    if(!found) {
        cout << "Все товары есть в наличии.\n";
    }
    cout << "================================================================================\n";
}

// Сортировка товаров
void sortProducts() {
    if(dbSize == 0) {
        cout << "База данных пуста.\n";
        return;
    }
    
    int choice;
    cout << "\nСортировка по полю:\n";
    cout << "1. По наименованию\n";
    cout << "2. По артикулу\n";
    cout << "3. По количеству\n";
    cout << "4. По цене\n";
    cout << "0. Отмена\n";
    cout << "Выберите поле для сортировки: ";
    cin >> choice;
    
    switch(choice) {
        case 1:
            qsort(database, dbSize, sizeof(Product), compareByName);
            cout << "Сортировка по наименованию выполнена.\n";
            break;
        case 2:
            qsort(database, dbSize, sizeof(Product), compareByArticle);
            cout << "Сортировка по артикулу выполнена.\n";
            break;
        case 3:
            qsort(database, dbSize, sizeof(Product), compareByQuantity);
            cout << "Сортировка по количеству выполнена.\n";
            break;
        case 4:
            qsort(database, dbSize, sizeof(Product), compareByPrice);
            cout << "Сортировка по цене выполнена.\n";
            break;
        case 0:
            cout << "Сортировка отменена.\n";
            break;
        default:
            cout << "Неверный выбор!\n";
    }
}

// Функции сравнения для qsort
int compareByName(const void* a, const void* b) {
    const Product* p1 = (const Product*)a;
    const Product* p2 = (const Product*)b;
    return strcmp(p1->name, p2->name);
}

int compareByArticle(const void* a, const void* b) {
    const Product* p1 = (const Product*)a;
    const Product* p2 = (const Product*)b;
    return (p1->article > p2->article) - (p1->article < p2->article);
}

int compareByQuantity(const void* a, const void* b) {
    const Product* p1 = (const Product*)a;
    const Product* p2 = (const Product*)b;
    return p1->quantity - p2->quantity;
}

int compareByPrice(const void* a, const void* b) {
    const Product* p1 = (const Product*)a;
    const Product* p2 = (const Product*)b;
    return (p1->price > p2->price) - (p1->price < p2->price);
}

// Очистка буфера ввода
void clearInputBuffer() {
    cin.clear();
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
}

// Проверка корректности данных товара
bool isValidProduct(const Product& p) {
    return (strlen(p.name) > 0 && 
            p.article > 0 && 
            p.quantity >= 0 && 
            p.price > 0 && 
            p.discount >= 0 && p.discount <= 100);
}
